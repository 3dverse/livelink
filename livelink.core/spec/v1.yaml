asyncapi: 3.0.0
info:
  title: 3dverse LiveLink Protocol
  version: 0.1.0
  description: This document describes the spec of the 3dverse LiveLink protocol applied between a client and both the rendering server and the persistence server

servers:
  # livelink:
  #   description: Persistence and broadcast service
  #   host: livelink.3dverse.com
  #   protocol: wss

  renderer:
    description: Rendering server streaming frames and handling real-time remote operations
    host: "{gateway_url}.3dverse.com"
    protocol: wss

channels:
  authentication:
    x-channel-id: 0
    address: authentication
    description: A single use channel that handles a single authentication message
    messages:
      authenticate_client:
        $ref: "#/components/messages/authenticate_client"
      authentication_response:
        $ref: "#/components/messages/authentication_response"
      authentication_error:
        $ref: "#/components/messages/authentication_error"

  registration:
    x-channel-id: 1
    address: registration
    description: A channel to send new connection configuration
    messages:
      configure_client:
        $ref: "#/components/messages/configure_client"
      on_client_configured:
        $ref: "#/components/messages/on_client_configured"

  heartbeat:
    x-channel-id: 11
    address: heartbeat
    description: Heartbeat channel between the client and the renderer
    messages:
      pulse_heartbeat:
        contentType: application/binary
      on_heartbeat_received:
        contentType: application/binary

  video-stream:
    x-channel-id: 2
    address: video-stream
    description: Channel receiving video frames
    messages:
      on_frame_received:
        $ref: "#/components/messages/on_frame_received"

  client-remote-operations:
    x-channel-id: 5
    address: client-remote-operations
    description: All remote operations linked to a particular client
    messages:
      cast_screen_space_ray:
        $ref: "#/components/messages/cast_screen_space_ray"
      cast_screen_space_ray_result:
        $ref: "#/components/messages/cast_screen_space_ray_result"
      highlight_entities:
        $ref: "#/components/messages/highlight_entities"

operations:
  authenticateClient:
    action: send
    channel:
      $ref: "#/channels/authentication"
    messages:
      - $ref: "#/channels/authentication/messages/authenticate_client"
    reply:
      channel:
        $ref: "#/channels/authentication"
      messages:
        - $ref: "#/channels/authentication/messages/authentication_response"
        - $ref: "#/channels/authentication/messages/authentication_error"

  configureClient:
    action: send
    channel:
      $ref: "#/channels/registration"
    messages:
      - $ref: "#/channels/registration/messages/configure_client"
    reply:
      channel:
        $ref: "#/channels/registration"
      messages:
        - $ref: "#/channels/registration/messages/on_client_configured"

  pulseHeartbeat:
    action: send
    channel:
      $ref: "#/channels/heartbeat"
    messages:
      - $ref: "#/channels/heartbeat/messages/pulse_heartbeat"
    reply:
      channel:
        $ref: "#/channels/heartbeat"
      messages:
        - $ref: "#/channels/heartbeat/messages/on_heartbeat_received"

  onFrameReceived:
    action: receive
    channel:
      $ref: "#/channels/video-stream"
    messages:
      - $ref: "#/channels/video-stream/messages/on_frame_received"

  castScreenSpaceRay:
    action: send
    x-rop-id: 3
    channel:
      $ref: "#/channels/client-remote-operations"
    messages:
      - $ref: "#/channels/client-remote-operations/messages/cast_screen_space_ray"
    reply:
      channel:
        $ref: "#/channels/client-remote-operations"
      messages:
        - $ref: "#/channels/client-remote-operations/messages/cast_screen_space_ray_result"

  highlightEntities:
    action: send
    x-rop-id: 4
    channel:
      $ref: "#/channels/client-remote-operations"
    messages:
      - $ref: "#/channels/client-remote-operations/messages/highlight_entities"

components:
  messages:
    authenticate_client:
      contentType: application/json
      payload:
        $ref: "#/components/schemas/SessionAuth"
    authentication_response:
      contentType: application/binary
      payload:
        $ref: "#/components/schemas/AuthenticationResponse"
    authentication_error:
      contentType: application/binary
      payload:
        $ref: "#/components/schemas/AuthenticationError"

    configure_client:
      contentType: application/json
      payload:
        $ref: "#/components/schemas/ClientConfig"
    on_client_configured:
      contentType: application/binary
      payload:
        $ref: "#/components/schemas/ClientConfigResponse"

    on_frame_received:
      contentType: application/binary
      payload:
        $ref: "#/components/schemas/VideoFrame"

    cast_screen_space_ray:
      contentType: application/binary
      payload:
        $ref: "#/components/schemas/ScreenSpaceRayQuery"
    cast_screen_space_ray_result:
      contentType: application/binary
      payload:
        $ref: "#/components/schemas/ScreenSpaceRayResult"

    highlight_entities:
      contentType: application/binary
      payload:
        description: Entities to highlight
        $ref: "#/components/schemas/EntityList"

  schemas:
    Vec3:
      title: Vec3
      type: array
      items:
        type: number
        format: float32
      minItems: 3
      maxItems: 3

    RTID:
      type: integer
      format: uint64

    EntityList:
      type: array
      items:
        $ref: "#/components/schemas/RTID"
      minItems: 1

    ScreenSpaceRayResult:
      type: object
      properties:
        entity_rtid:
          $ref: "#/components/schemas/RTID"
        position:
          $ref: "#/components/schemas/Vec3"
        normal:
          $ref: "#/components/schemas/Vec3"

    ScreenSpaceRayQuery:
      type: object
      properties:
        camera_rtid:
          $ref: "#/components/schemas/RTID"
        x:
          type: number
          format: float32
        y:
          type: number
          format: float32
        mode:
          type: integer
          format: uint8

    SessionAuth:
      type: object
      properties:
        session_key:
          type: string
        client_app:
          type: string
          example: "Hololens 2"
        os:
          type: string
          example: "Win32"

    VideoFrame:
      type: object
      properties:
        image_size:
          type: integer
          format: int32
        meta_data_size:
          type: integer
          format: int32
        encoded_image:
          type: string
          format: binary
          x-size: image_size
        meta_data:
          type: string
          format: binary
          x-size: meta_data_size

    ClientConfigResponse:
      type: object
      properties:
        codec:
          type: integer
          format: int8

    ClientConfig:
      type: object
      properties:
        rendering_area_size:
          type: array
          items:
            type: integer
            minimum: 16
            maximum: 3840
            multipleOf: 4
          minItems: 2
          maxItems: 2
        encoder_config:
          type: object
          properties:
            codec:
              type: integer
              default: 0
            profile:
              type: integer
              default: 0
            frame_rate:
              type: integer
              default: 30
            lossy:
              type: boolean
              default: true
            mp4:
              type: boolean
              default: false
        input_devices:
          type: object
          properties:
            has_keyboard:
              type: boolean
            has_mouse:
              type: boolean
            has_hololens:
              type: boolean
            has_gamepad:
              type: boolean
            has_touchscreen:
              type: boolean

    AuthenticationStatusError:
      oneOf:
        - type: integer
          format: int16
          const: 0
          title: Unknown error

        - type: integer
          format: int16
          const: 100
          title: Authentication failed
        - type: integer
          format: int16
          const: 101
          title: Session not found
        - type: integer
          format: int16
          const: 102
          title: Session closed

        - type: integer
          format: int16
          const: 200
          title: Launcher not found
        - type: integer
          format: int16
          const: 201
          title: Unknown service
        - type: integer
          format: int16
          const: 202
          title: Service boot error

        - type: integer
          format: int16
          const: 300
          title: Invalid request
        - type: integer
          format: int16
          const: 301
          title: Duplicated session

        - type: integer
          format: int16
          const: 400
          title: Client not found

    AuthenticationError:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/AuthenticationStatusError"

    AuthenticationResponse:
      type: object
      properties:
        status:
          title: Success
          type: integer
          format: int16
          const: 1
        client_id:
          type: string
          format: uuid
