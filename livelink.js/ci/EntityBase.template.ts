/**
 * DO NOT EDIT THIS FILE MANUALLY.
 * This file has been generated automatically from ftl-schemas
 */
import { LivelinkCoreModule } from "@3dverse/livelink.core";
import type { Components, EditorEntity, EntityInterface, RTID, UUID } from "@3dverse/livelink.core";

/**
 *
 */
export class EntityBase extends EventTarget implements EntityInterface {
    /**
     *
     */
    private euid: Components.Euid | null = null;

{{componentAttributes}}

    /**
     * @internal
     */
    get rtid(): RTID | null {
        return this.euid?.rtid ?? null;
    }

    /**
     * The UUID of the entity.
     *
     * Note that multiple entities can share the same UUID if they are different instances of the
     * same entity brought by multiple instances of the same scene.
     */
    get id(): UUID | null {
        return this.euid?.value ?? null;
    }

    /**
     * The name of the entity.
     */
    get name(): string {
        return this.debug_name?.value ?? "<unnamed>";
    }

    /**
     *
     */
    protected _isInstantiated(): boolean {
        return this.euid !== null && this.euid.rtid !== BigInt(0);
    }

    /**
     *
     */
    protected _setEuid(euid: UUID) {
        this.euid = { value: euid, rtid: BigInt(0) };
    }

    /**
     *
     */
    protected _is_visible: boolean = true;

    /**
     *
     */
    protected _initFromEditorEntity({ editor_entity }: { editor_entity: EditorEntity }) {
        const components = editor_entity.components;
        if (!components.euid) {
            throw new Error("Trying to parse an entity without EUID");
        }

        this.euid = {
            value: (components.euid as { value: UUID }).value,
            rtid: BigInt(editor_entity.rtid),
        };

        this._is_visible = editor_entity.isVisible;

        delete components.euid;

        for (const component_type in components) {
            //@ts-expect-error - to fix this components should be of type ComponentsRecord
            // on the core side.
            this[component_type] = components[component_type];
        }

        // Remove any undefined component
        for (const k of Object.keys(this)) {
            const key = k as keyof EntityBase;
            if (this[key] === undefined) {
                delete this[key];
            }
        }
    }

    /**
     * @internal
     */
    toJSON() {
        const serialized: Record<string, unknown> = {};
        for (const p in this) {
            if (this._isSerializableComponent(p, this[p])) {
                serialized[p as string] = this[p];
            }
        }
        return serialized;
    }

    /**
     * @internal
     */
    public _isSerializableComponent(prop: PropertyKey, v: unknown) {
        return (
            typeof prop === "string" &&
            v !== undefined &&
            prop[0] !== "_" &&
            Object.values(LivelinkCoreModule.Enums.ComponentsHashes).includes(prop)
        );
    }
}
