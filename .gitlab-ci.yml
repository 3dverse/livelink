# SETTINGS ############################################################################################################
include:
  - project: 3dverse/platform/ci-utils/gitlab-templates
    file:
      - /ci/.bases/_index.yaml
      - /ci/.bases/regcreds.yaml
      - /ci/.bases/node/_index.yaml

variables:
  NODE_VERSION: "18"

# JOBS ################################################################################################################
# BUILD
js:livelink:build:
  extends:
    - .env-dev
    - .runner-onprem
  image: node:${NODE_VERSION}
  before_script:
    - !reference [.npm-regcreds, before_script]
    - !reference [.node-cache, before_script]
  script:
    - npm run build
    - cd livelink.samples
    - npm run build
  artifacts:
    expire_in: 1 day
    paths:
      - livelink.core/dist/
      - livelink.js/dist/
      - livelink.samples/dist/
  rules:
    - when: always

# DEPLOY
js:livelink.core:deploy:
  stage: deploy
  extends:
    - .env-prod
    - .runner-onprem
  image: registry.gitlab.com/3dverse/platform/ci-utils/docker-images/gcloud-kubectl-sops:latest
  needs:
    - job: js:livelink:build
      artifacts: true
  variables:
    BUCKET_NAME: livelink-prod
    BUCKET_FOLDER_NAME: core
  script:
    - |
      set -e
      gcloud auth activate-service-account --key-file="${GCP_GCS_APPLICATION_CREDENTIALS}" --project="${GOOGLE_PROJECT_ID}"

      SOURCE_PATH="livelink.core/dist/*.mjs*"
      TARGET_PATH="gs://$BUCKET_NAME/$BUCKET_FOLDER_NAME"

      echo "Uploading \"${SOURCE_PATH}\" to \"${TARGET_PATH}\""
      gsutil -m -h "Cache-Control:public, max-age=0" cp $SOURCE_PATH $TARGET_PATH
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.core/**/*
        - livelink.core/*

# GITLAB PAGE
pages:
  stage: deploy
  extends:
    - .env-dev
    - .runner-onprem
  artifacts:
    paths:
      - public/
  needs:
    - job: js:livelink:build
      artifacts: true
  before_script:
    - mkdir public
  script:
    - cp -r livelink.samples/dist/* public/
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
#######################################################################################################################
