# SETTINGS ############################################################################################################
include:
  - project: 3dverse/platform/ci-utils/gitlab-templates
    file:
      - /ci/.bases/_index.yaml
      - /ci/.bases/regcreds.yaml
      - /ci/.bases/node/_index.yaml

variables:
  NODE_VERSION: "22"
  LIVELINK_JS_PACKAGE: livelink.js/3dverse-livelink
  LIVELINK_THREE_PACKAGE: livelink.three/3dverse-livelink-three
  LIVELINK_REACT_PACKAGE: livelink.react/3dverse-livelink-react
  LIVELINK_REACT_UI_PACKAGE: livelink.react.ui/3dverse-livelink-react-ui
  LIVELINK_SAMPLES_PACKAGE: livelink.samples/livelink.samples

# TEMPLATES ###########################################################################################################
.build:
  stage: build
  extends:
    - .env-dev
    - .runner-onprem
  image: node:${NODE_VERSION}
  artifacts:
    expire_in: 1 day
    paths:
      - $PACKAGE_DIR/$PACKAGE_PATH_NAME-*.tgz
      - $PACKAGE_DIR/_prebuild/
      - $PACKAGE_DIR/dist/
  before_script:
    - !reference [.npm-regcreds, before_script]
    - cd $PACKAGE_DIR
    - !reference [.node-cache, before_script]
  script:
    - npm run build
    - npm pack
  rules:
    - when: always

.update-version:
  script:
    - |
      set -e
      latest_published_version=$(npm show @3dverse/$PACKAGE_NAME version)
      npm install semver --no-save

      semver_script="const semver = require('semver'); \
      const latest = '$latest_published_version'; \
      const current = require('./package.json').version; \
      if(semver.gte(latest, current)) { \
        console.log(semver.inc(latest, 'patch')); \
      }"

      new_package_version=$(node -e "$semver_script")
      if [ "$new_package_version" != "" ]; then
        npm version $new_package_version --no-git-tag-version
      fi

.publish:
  stage: deploy
  extends:
    - .runner-onprem
  image: node:${NODE_VERSION}
  before_script:
    - !reference [.npm-regcreds, before_script]
    - npm config set @3dverse:registry="https://registry.npmjs.org" --userconfig=".npmrc"
    - npm config set //registry.npmjs.org/:_authToken="${NPMJS_ACCESS_TOKEN}" --userconfig=".npmrc"
    - tar -zxf ${PACKAGE_PATH_NAME}-*.tgz --strip-components=1 -C $PACKAGE_DIR
    - cd $PACKAGE_DIR
    - npm pkg delete private
  script:
    - npm publish --access public

.docs:
  stage: deploy
  extends:
    - .env-dev
    - .runner-onprem
  image: node:${NODE_VERSION}
  before_script:
    - !reference [.npm-regcreds, before_script]
    - cd $PACKAGE_DIR
    - !reference [.node-cache, before_script]
  script:
    - npm run typedoc:md
    - tar -zcvf docs-md.tgz -C docs-md/ .
    - |
      echo "Publishing $PACKAGE_DIR docs"

      echo "Package latest"
      curl \
          --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
          --upload-file docs-md.tgz \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_DIR}/latest/docs-md.tgz"

      if [ -n "$CI_COMMIT_TAG" ]; then
          echo "Package $CI_COMMIT_TAG"
          curl \
              --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
              --upload-file docs-md.tgz \
              "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_DIR}/${CI_COMMIT_TAG}/docs-md.tgz"
      fi

# JOBS ################################################################################################################
# BUILD
js:livelink.js:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.js
    PACKAGE_PATH_NAME: 3dverse-livelink

js:livelink.react:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.react
    PACKAGE_PATH_NAME: 3dverse-livelink-react
  needs:
    - job: js:livelink.js:build
      artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

js:livelink.three:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.three
    PACKAGE_PATH_NAME: 3dverse-livelink-three
  needs:
    - job: js:livelink.js:build
      artifacts: true
    - job: js:livelink.react:build
      artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    - tar -zxf ${LIVELINK_REACT_PACKAGE}-*.tgz --strip-components=1 -C livelink.react
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

js:livelink.react.ui:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.react.ui
    PACKAGE_PATH_NAME: 3dverse-livelink-react-ui
  needs:
    - job: js:livelink.js:build
      artifacts: true
    # - job: js:livelink.react:build
    #   artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    # - tar -zxf ${LIVELINK_REACT_PACKAGE}-*.tgz --strip-components=1 -C livelink.react
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

js:livelink.samples:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.samples
    PACKAGE_PATH_NAME: livelink.samples
  needs:
    - job: js:livelink.js:build
      artifacts: true
    - job: js:livelink.three:build
      artifacts: true
    - job: js:livelink.react:build
      artifacts: true
    - job: js:livelink.react.ui:build
      artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    - tar -zxf ${LIVELINK_THREE_PACKAGE}-*.tgz --strip-components=1 -C livelink.three
    - tar -zxf ${LIVELINK_REACT_PACKAGE}-*.tgz --strip-components=1 -C livelink.react
    - tar -zxf ${LIVELINK_REACT_UI_PACKAGE}-*.tgz --strip-components=1 -C livelink.react.ui
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

# DEPLOY
js:livelink.js:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.js:build
      artifacts: true
  variables:
    PACKAGE_DIR: livelink.js
    PACKAGE_PATH_NAME: $LIVELINK_JS_PACKAGE
  rules:
    - if: $CI_COMMIT_TAG != null

js:livelink.react:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.react:build
      artifacts: true
  variables:
    PACKAGE_NAME: livelink-react
    PACKAGE_DIR: livelink.react
    PACKAGE_PATH_NAME: $LIVELINK_REACT_PACKAGE
  script:
    - !reference [.update-version, script]
    - !reference [.publish, script]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.react/**/*
        - livelink.react/*

js:livelink.three:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.three:build
      artifacts: true
  variables:
    PACKAGE_NAME: livelink-three
    PACKAGE_DIR: livelink.three
    PACKAGE_PATH_NAME: $LIVELINK_THREE_PACKAGE
  script:
    - !reference [.update-version, script]
    - !reference [.publish, script]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.three/**/*
        - livelink.three/*

js:livelink.react.ui:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.react.ui:build
      artifacts: true
  variables:
    PACKAGE_NAME: livelink-react-ui
    PACKAGE_DIR: livelink.react.ui
    PACKAGE_PATH_NAME: $LIVELINK_REACT_UI_PACKAGE
  script:
    - !reference [.update-version, script]
    - !reference [.publish, script]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.react.ui/**/*
        - livelink.react.ui/*

# DOCS
pages:
  stage: deploy
  extends:
    - .env-dev
    - .runner-onprem
  needs:
    - job: js:livelink.samples:build
      artifacts: true
  artifacts:
    paths:
      - public/
  before_script:
    - mkdir public
  script:
    - tar -zxf ${LIVELINK_SAMPLES_PACKAGE}-*.tgz --strip-components=2 -C public
  rules:
    - if: $CI_COMMIT_TAG != null
      when: never
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH

js:livelink.js:docs:
  stage: deploy
  extends:
    - .docs
  needs:
    - job: js:livelink.js:build
      artifacts: true
  variables:
    PACKAGE_DIR: livelink.js
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.js/**/*
        - livelink.js/*
    - when: never

js:livelink.react:docs:
  stage: deploy
  extends:
    - .docs
  needs:
    - job: js:livelink.js:build
      artifacts: true
    - job: js:livelink.react:build
      artifacts: true
  variables:
    PACKAGE_DIR: livelink.react
  rules:
    # FIXME: The rules aren't correct, it should be performed after the publish job of livelink.react
    # using the version number determined in the publish job.
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.react/**/*
        - livelink.react/*
    - when: never

js:livelink.js:docs-trigger:
  stage: deploy
  needs:
    - job: js:livelink.js:docs
      artifacts: false
  variables:
    # This variable will be used in the triggered downstream pipeline to download the generated docs artifact.
    LIVELINK_JS_PACKAGE_URL: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/livelink.js/${CI_COMMIT_TAG}/docs-md.tgz
    SYNC_LIVELINK_JS: "true"
  rules:
    - if: $CI_COMMIT_TAG
    - when: never
  trigger:
    project: 3dverse/corp/3dverse-docs
    strategy: depend
