# SETTINGS ############################################################################################################
include:
  - project: 3dverse/platform/ci-utils/gitlab-templates
    file:
      - /ci/.bases/_index.yaml
      - /ci/.bases/regcreds.yaml
      - /ci/.bases/node/_index.yaml

variables:
  NODE_VERSION: "18"
  LIVELINK_JS_PACKAGE: livelink.js/3dverse-livelink
  LIVELINK_THREE_PACKAGE: livelink.three/3dverse-livelink-three
  LIVELINK_REACT_PACKAGE: livelink.react/3dverse-livelink-react
  LIVELINK_SAMPLES_PACKAGE: livelink.samples/livelink.samples

# TEMPLATES ###########################################################################################################
.build:
  stage: build
  extends:
    - .env-dev
    - .runner-onprem
  image: node:${NODE_VERSION}
  variables:
    PACKAGE_NAME: $PACKAGE_DIR
  artifacts:
    expire_in: 1 day
    paths:
      - $PACKAGE_DIR/$PACKAGE_NAME-*.tgz
  before_script:
    - !reference [.npm-regcreds, before_script]
    - cd $PACKAGE_DIR
    - !reference [.node-cache, before_script]
  script:
    - npm run build
    - npm pack
  rules:
    - when: always

.publish:
  stage: deploy
  extends:
    - .runner-onprem
  image: node:${NODE_VERSION}
  before_script:
    - !reference [.npm-regcreds, before_script]
    - npm config set @3dverse:registry="https://registry.npmjs.org" --userconfig=".npmrc"
    - npm config set //registry.npmjs.org/:_authToken="${NPMJS_ACCESS_TOKEN}" --userconfig=".npmrc"
    - tar -zxf ${PACKAGE_NAME}-*.tgz --strip-components=1 -C $PACKAGE_DIR
    - cd $PACKAGE_DIR
    - npm pkg delete private
  script:
    - npm publish --access public

# JOBS ################################################################################################################
# BUILD
js:livelink.js:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.js
    PACKAGE_NAME: 3dverse-livelink

js:livelink.three:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.three
    PACKAGE_NAME: 3dverse-livelink-three
  needs:
    - job: js:livelink.js:build
      artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

js:livelink.react:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.react
    PACKAGE_NAME: 3dverse-livelink-react
  needs:
    - job: js:livelink.js:build
      artifacts: true
    - job: js:livelink.three:build
      artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    - tar -zxf ${LIVELINK_THREE_PACKAGE}-*.tgz --strip-components=1 -C livelink.three
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

js:livelink.samples:build:
  extends:
    - .build
  variables:
    PACKAGE_DIR: livelink.samples
  needs:
    - job: js:livelink.js:build
      artifacts: true
    - job: js:livelink.three:build
      artifacts: true
    - job: js:livelink.react:build
      artifacts: true
  before_script:
    - tar -zxf ${LIVELINK_JS_PACKAGE}-*.tgz --strip-components=1 -C livelink.js
    - tar -zxf ${LIVELINK_THREE_PACKAGE}-*.tgz --strip-components=1 -C livelink.three
    - tar -zxf ${LIVELINK_REACT_PACKAGE}-*.tgz --strip-components=1 -C livelink.react
    - !reference [.build, before_script]
  rules:
    - if: $CI_COMMIT_TAG == null

# DEPLOY
js:livelink.js:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.js:build
      artifacts: true
  variables:
    PACKAGE_DIR: livelink.js
    PACKAGE_NAME: $LIVELINK_JS_PACKAGE
  rules:
    - if: $CI_COMMIT_TAG != null

js:livelink.three:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.three:build
      artifacts: true
  variables:
    PACKAGE_DIR: livelink.three
    PACKAGE_NAME: $LIVELINK_THREE_PACKAGE
  script:
    - |
      set -e
      latest_published_version=$(npm show @3dverse/livelink-three version)
      current_version=$(node -e "console.log(require('./package.json').version)")

      if [ "$latest_published_version" != "$current_version" ]; then
        npm version $latest_published_version --no-git-tag-version
      fi
      npm version patch --no-git-tag-version
    - !reference [.publish, script]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.three/**/*
        - livelink.three/*

js:livelink.react:publish:
  stage: deploy
  extends:
    - .publish
  needs:
    - job: js:livelink.react:build
      artifacts: true
  variables:
    PACKAGE_DIR: livelink.react
    PACKAGE_NAME: $LIVELINK_REACT_PACKAGE
  script:
    - |
      set -e
      latest_published_version=$(npm show @3dverse/livelink-react version)
      current_version=$(node -e "console.log(require('./package.json').version)")

      if [ "$latest_published_version" != "$current_version" ]; then
        npm version $latest_published_version --no-git-tag-version
      fi
      npm version patch --no-git-tag-version
    - !reference [.publish, script]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - livelink.react/**/*
        - livelink.react/*

# GITLAB PAGE
pages:
  stage: deploy
  extends:
    - .env-dev
    - .runner-onprem
  artifacts:
    paths:
      - public/
  before_script:
    - mkdir public
  script:
    - tar -zxf ${LIVELINK_SAMPLES_PACKAGE}-*.tgz --strip-components=2 -C public
  rules:
    - if: $CI_COMMIT_TAG != null
      when: never
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
#######################################################################################################################
